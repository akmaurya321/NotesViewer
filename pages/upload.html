<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Upload & Share — Notes Viewer</title>
  <link rel="icon" href="data:,">
  <style>
    :root{--muted:#9aa6bf;--accent:#0ea5e9}
    body{margin:0;font-family:Inter,system-ui;background:#071320;color:#e8f3ff}
    .wrap{display:flex;justify-content:center;padding:32px}
    .card{width:720px;max-width:94%;background:rgba(255,255,255,0.03);
      border:1px solid rgba(255,255,255,0.05);border-radius:14px;padding:26px;
      box-shadow:0 10px 40px rgba(0,0,0,0.5)}
    h1{margin:0 0 8px;font-size:22px}
    .btn,.input,.filebtn{padding:10px 14px;border-radius:10px;border:1px solid rgba(255,255,255,0.08);
      background:rgba(255,255,255,0.06);color:#e8f3ff;cursor:pointer}
    .btn:hover{background:rgba(255,255,255,0.12)}
    .muted{color:var(--muted);font-size:13px}
    .result{background:rgba(255,255,255,0.05);padding:12px;margin-top:14px;border-radius:10px}
    .progress{height:8px;background:rgba(255,255,255,0.1);border-radius:8px;overflow:hidden;margin-top:12px}
    .progress div{height:100%;width:0;background:var(--accent);transition:width .2s}
    a{color:var(--accent);text-decoration:none}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">

      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <h1>Upload & Share</h1>
          <div class="muted">Upload your note & get a share link instantly.</div>
        </div>
        <a href="/">← Back</a>
      </div>

      <!-- USER ACCOUNT -->
      <div style="margin-top:18px">
        <label class="muted">Create username (first time only)</label>
        <div style="display:flex;gap:8px;margin-top:6px">
          <input id="uidInput" class="input" placeholder="choose user id" style="flex:1">
          <button id="checkBtn" class="btn">Check</button>
        </div>
        <div id="uidMsg" class="muted" style="margin-top:6px"></div>
      </div>

      <!-- SIGNED IN -->
      <div id="loginBox" style="margin-top:10px;display:none">
        <div class="muted">Signed in as <span id="showUid"></span></div>
      </div>

      <!-- FILE UPLOAD -->
      <div style="margin-top:22px">
        <label class="muted">Choose file</label>
        <div style="display:flex;gap:10px;margin-top:6px">
          <input id="fileInput" type="file" class="filebtn">
          <button id="uploadBtn" class="btn">Upload</button>
        </div>
        <div class="muted" style="margin-top:6px">
          Allowed: html, pdf, mp4, gif, png, jpg, json — Max 10MB
        </div>
      </div>

      <!-- PROGRESS -->
      <div id="progressWrap" style="display:none">
        <div class="progress"><div id="pbar"></div></div>
        <div id="progressText" class="muted">Uploading 0%</div>
      </div>

      <!-- RESULT -->
      <div id="result" class="result" style="display:none">
        <strong>Share Link</strong>
        <input id="shareInput" class="input" readonly style="width:100%;margin-top:8px">
        <div style="display:flex;gap:10px;margin-top:10px">
          <button id="copyBtn" class="btn">Copy</button>
          <button id="openBtn" class="btn">Open</button>
          <button id="closeBtn" class="btn">Close</button>
        </div>
      </div>

    </div>
  </div>

<script>
const API = "https://notesviewerbackend.onrender.com";

/* -------------------- LOGIN STORAGE -------------------- */
let userId = localStorage.getItem("nv_userId");
let token  = localStorage.getItem("nv_token");

const uidInput = document.getElementById("uidInput");
const checkBtn = document.getElementById("checkBtn");
const uidMsg   = document.getElementById("uidMsg");
const loginBox = document.getElementById("loginBox");
const showUid  = document.getElementById("showUid");

const uploadBtn  = document.getElementById("uploadBtn");
const fileInput  = document.getElementById("fileInput");

const progressWrap = document.getElementById("progressWrap");
const pbar         = document.getElementById("pbar");
const progressText = document.getElementById("progressText");

const result     = document.getElementById("result");
const shareInput = document.getElementById("shareInput");
const copyBtn    = document.getElementById("copyBtn");
const openBtn    = document.getElementById("openBtn");
const closeBtn   = document.getElementById("closeBtn");

function refreshLogin(){
  if(userId && token){
    loginBox.style.display = "block";
    showUid.textContent = userId;
  }
}
refreshLogin();

/* -------------------- CHECK USER ID -------------------- */
checkBtn.onclick = async ()=>{
  const u = uidInput.value.trim();
  if(!u) return;

  uidMsg.style.color = "#9aa6bf";
  uidMsg.textContent = "Checking...";

  const r = await fetch(`${API}/check/${u}`);
  const j = await r.json();

  if(j.available){
    uidMsg.style.color = "#00d97e";
    uidMsg.textContent = "Available ✓ Creating account...";

    registerUser(u);
  } else {
    uidMsg.style.color = "red";
    uidMsg.textContent = "Already taken ✗";
  }
};

/* -------------------- REGISTER USER -------------------- */
async function registerUser(u){
  const r = await fetch(`${API}/register`, {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ userId: u })
  });
  const j = await r.json();

  if(j.success){
    localStorage.setItem("nv_userId", j.userId);
    localStorage.setItem("nv_token", j.token);
    userId = j.userId;
    token  = j.token;

    uidMsg.style.color = "#00d97e";
    uidMsg.textContent = "Account created ✔";

    refreshLogin();
  } else {
    uidMsg.style.color = "red";
    uidMsg.textContent = j.error;
  }
}

/* -------------------- UPLOAD FILE -------------------- */
uploadBtn.onclick = async ()=>{
  if(!userId || !token) return alert("Create username first.");
  const f = fileInput.files[0];
  if(!f) return alert("Select a file.");

  if(f.size > 10*1024*1024) return alert("Max 10MB allowed");

  progressWrap.style.display = "block";
  pbar.style.width = "10%";
  progressText.textContent = "Uploading...";

  const form = new FormData();
  form.append("file", f);
  form.append("userId", userId);
  form.append("token", token);

  const r = await fetch(`${API}/upload`, { method:"POST", body: form });
  const j = await r.json();

  if(!j.success){
    alert(j.error);
    progressWrap.style.display = "none";
    return;
  }

  pbar.style.width = "100%";
  progressText.textContent = "Done ✔";

  result.style.display = "block";
  shareInput.value = `${location.origin}/?file=${encodeURIComponent(j.url)}`;
};

/* -------------------- COPY URL -------------------- */
copyBtn.onclick = ()=>{
  navigator.clipboard.writeText(shareInput.value);
  copyBtn.textContent = "Copied!";
  setTimeout(()=>copyBtn.textContent="Copy",1200);
};

/* -------------------- OPEN -------------------- */
openBtn.onclick = ()=> window.open(shareInput.value, "_blank");

/* -------------------- CLOSE -------------------- */
closeBtn.onclick = ()=> result.style.display = "none";
</script>

</body>
</html>
