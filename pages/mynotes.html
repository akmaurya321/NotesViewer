<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My Notes — Notes Viewer</title>

  <style>
    :root{--bg:#071320;--card:rgba(255,255,255,0.03);--muted:#9aa6bf;--accent:#0ea5e9}
    html,body{
      height:100%;margin:0;
      font-family:Inter,system-ui,Segoe UI,Roboto,Arial;
      background:linear-gradient(180deg,#071320,#04101a);
      color:#e8f3ff;
    }
    .wrap{min-height:100%;display:flex;align-items:center;justify-content:center;padding:32px}
    .card{
      width:820px;max-width:96%;
      background:var(--card);
      border-radius:14px;padding:22px;
      box-shadow:0 10px 40px rgba(2,6,23,0.8);
      border:1px solid rgba(255,255,255,0.05)
    }
    h1{margin:0 0 6px 0;font-size:20px}
    .tiny{font-size:13px;color:var(--muted)}
    .btn{
      background:rgba(255,255,255,0.06);
      border-radius:10px;padding:8px 12px;
      border:1px solid rgba(255,255,255,0.06);
      cursor:pointer;
      transition:0.18s;
      color:#e8f3ff;
    }
    .btn:hover{background:rgba(255,255,255,0.1)}
    .list{
      margin-top:16px;display:flex;flex-direction:column;
      gap:10px;max-height:55vh;overflow:auto;
    }
    .note{
      display:flex;justify-content:space-between;align-items:center;
      background:rgba(255,255,255,0.03);
      padding:12px;border-radius:10px;
    }
    .note .meta strong{font-size:14px}
    .note .meta small{color:var(--muted)}
    .actions{display:flex;gap:8px}
    a.link{color:var(--accent);text-decoration:none}
  </style>
</head>
<body>

<div class="wrap">
  <div class="card">

    <!-- FIXED BACK BUTTON -->
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <h1>My Notes</h1>
        <div class="tiny">Notes uploaded by you.</div>
      </div>
      <a class="link" href="../index.html">← Back to Viewer</a>
    </div>

    <div id="userRow" style="margin-top:12px;font-size:14px;color:var(--muted)"></div>

    <div class="list" id="notesList">
      <div class="tiny">Loading…</div>
    </div>

    <div id="empty" style="display:none;color:var(--muted);margin-top:10px">
      You have no uploaded notes.
    </div>

  </div>
</div>


<script>
const API = "https://notesviewerbackend.onrender.com";

let userId = localStorage.getItem("nv_userId");
let token  = localStorage.getItem("nv_token");

const notesList = document.getElementById("notesList");
const emptyBox  = document.getElementById("empty");
const userRow   = document.getElementById("userRow");

/* LOGIN CHECK */
if(!userId || !token){
  notesList.innerHTML = "<div class='tiny'>Please create an account first.</div>";
  userRow.innerHTML = `<span style="color:#f88">No account found.</span>`;
} else {
  userRow.innerHTML = `Logged in as <b>${userId}</b>`;
  loadNotes();
}

/* LOAD USER NOTES */
async function loadNotes(){
  notesList.innerHTML = "<div class='tiny'>Loading…</div>";

  try{
    const res = await fetch(`${API}/list/${userId}`);
    const data = await res.json();

    if(!data.success){
      notesList.innerHTML = "<div class='tiny'>Failed to load notes.</div>";
      return;
    }

    const files = data.files;

    if(files.length === 0){
      notesList.innerHTML = "";
      emptyBox.style.display = "block";
      return;
    }

    emptyBox.style.display = "none";
    notesList.innerHTML = "";

    files.forEach(f => {
      const el = document.createElement("div");
      el.className = "note";

      const meta = document.createElement("div");
      meta.className = "meta";
      meta.innerHTML = `
        <strong>${f.name}</strong>
        <small>${f.path}</small>
      `;

      const actions = document.createElement("div");
      actions.className = "actions";

      /* ---- OPEN ---- */
      const openBtn = document.createElement("button");
      openBtn.className = "btn";
      openBtn.textContent = "Open";
      openBtn.onclick = () => {
        const viewer = `${location.origin}/NotesViewer/index.html?file=${encodeURIComponent(f.download_url)}`;
        window.open(viewer, "_blank");
      };

      /* ---- COPY ---- */
      const copyBtn = document.createElement("button");
      copyBtn.className = "btn";
      copyBtn.textContent = "Copy";
      copyBtn.onclick = () => {
        const viewer = `${location.origin}/NotesViewer/index.html?file=${encodeURIComponent(f.download_url)}`;
        navigator.clipboard.writeText(viewer);
        copyBtn.textContent = "Copied!";
        setTimeout(()=>copyBtn.textContent="Copy",800);
      };

      /* ---- DELETE ---- */
      const delBtn = document.createElement("button");
      delBtn.className = "btn";
      delBtn.textContent = "Delete";
      delBtn.onclick = () => deleteFile(f.path, el);

      actions.append(openBtn, copyBtn, delBtn);
      el.append(meta, actions);
      notesList.appendChild(el);
    });

  }catch(err){
    notesList.innerHTML = "<div class='tiny'>Error loading notes.</div>";
  }
}

/* DELETE FILE */
async function deleteFile(path, element){
  if(!confirm("Delete this note?")) return;

  const res = await fetch(`${API}/delete`, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ filePath: path, userId, token })
  });

  const data = await res.json();

  if(data.success){
    element.remove();
  } else {
    alert("Delete failed: " + (data.error || ""));
  }
}
</script>

</body>
</html>
